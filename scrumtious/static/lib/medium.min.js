/*
 * Medium.js
 *
 * Copyright 2013-2014, Jacob Kelley - http://jakiestfu.com/
 * Released under the MIT Licence
 * http://opensource.org/licenses/MIT
 *
 * Github:  http://github.com/jakiestfu/Medium.js/
 * Version: master
 */
 
(function(e,t){"use strict";var n=function(){var n,i=e.rangy||null,o=e.Undo||null,r=!i||!o,a=e.Key={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capsLock:20,escape:27,pageUp:33,pageDown:34,end:35,home:36,leftArrow:37,upArrow:38,rightArrow:39,downArrow:40,insert:45,"delete":46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,leftWindow:91,rightWindowKey:92,select:93,numpad0:96,numpad1:97,numpad2:98,numpad3:99,numpad4:100,numpad5:101,numpad6:102,numpad7:103,numpad8:104,numpad9:105,multiply:106,add:107,subtract:109,decimalPoint:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numLock:144,scrollLock:145,semiColon:186,equalSign:187,comma:188,dash:189,period:190,forwardSlash:191,graveAccent:192,openBracket:219,backSlash:220,closeBraket:221,singleQuote:222},l=function(t){var i,o,s,d,c=this,u=new l.Action,h=new l.Cache,f=new l.Cursor,m=new l.Selection,p={focus:function(t){t=t||e.event,l.activeElement=i,c.placeholders()},blur:function(t){t=t||e.event,l.activeElement===i&&(l.activeElement=null),c.placeholders()},down:function(t){t=t||e.event;var i=!0;if(229!==t.keyCode){if(n.isCommand(v,t,function(){h.cmd=!0},function(){h.cmd=!1}),n.isShift(t,function(){h.shift=!0},function(){h.shift=!1}),n.isModifier(v,t,function(e){if(h.cmd){if((v.mode===l.inlineMode||v.mode===l.partialMode)&&"paste"!==e)return void n.preventDefaultEvent(t);var o=typeof e,r=null;r="function"===o?e:p.command[e],i=r.call(c,t),i===!1&&(n.preventDefaultEvent(t),n.stopPropagation(t))}}),-1!==v.maxLength){var o=n.text().length,r=!1,s=e.getSelection();if(s&&(r=!s.isCollapsed),o>=v.maxLength&&!n.isSpecial(t)&&!n.isNavigational(t)&&!r)return v.maxLengthReached(v.element),n.preventDefaultEvent(t)}switch(t.keyCode){case a.enter:p.enterKey(t);break;case a.backspace:case a["delete"]:p.backspaceOrDeleteKey(t)}return i}},up:function(t){t=t||e.event,n.isCommand(v,t,function(){h.cmd=!1},function(){h.cmd=!0}),c.clean(),c.placeholders();var i;if(null!==v.keyContext&&(i=v.keyContext[t.keyCode])){var o=f.parent();o&&i.call(c,t,o)}u.preserveElementFocus()},command:{bold:function(e){n.preventDefaultEvent(e),new l.Element(c,"bold").setClean(!1).invoke(v.beforeInvokeElement)},underline:function(e){n.preventDefaultEvent(e),new l.Element(c,"underline").setClean(!1).invoke(v.beforeInvokeElement)},italicize:function(e){n.preventDefaultEvent(e),new l.Element(c,"italic").setClean(!1).invoke(v.beforeInvokeElement)},quote:function(e){},paste:function(e){if(c.makeUndoable(),v.pasteAsText){var t=n.selection.saveSelection();n.pasteHook(function(e){n.selection.restoreSelection(t),e=e.replace(/\n/g,"<br>"),new l.Html(c,e).setClean(!1).insert(v.beforeInsertHtml,!0),c.clean(),c.placeholders()})}else c.clean(),c.placeholders()}},enterKey:function(e){if(v.mode===l.inlineMode||v.mode===l.inlineRichMode)return n.preventDefaultEvent(e);if(h.shift){if(v.tags["break"])return n.preventDefaultEvent(e),c.addTag(v.tags["break"],!0),!1}else{var t,o,r,a=n.atCaret(c)||{},s=i.children,d=a===i.lastChild?i.lastChild:null;d&&d!==i.firstChild&&v.autoHR&&"partial"!==v.mode&&v.tags.horizontalRule&&(n.preventDefaultEvent(e),t=""===n.text(d)&&d.nodeName.toLowerCase()===v.tags.paragraph,t&&s.length>=2&&(o=s[s.length-2],o.nodeName.toLowerCase()===v.tags.horizontalRule&&(t=!1)),t&&(c.addTag(v.tags.horizontalRule,!1,!0,a),a=a.nextSibling),null!==(r=c.addTag(v.tags.paragraph,!0,null,a))&&(r.innerHTML="",f.set(c,0,r)))}return!0},backspaceOrDeleteKey:function(e){if(void 0!==v.onBackspaceOrDelete){var t=v.onBackspaceOrDelete.call(c,e,i);if(t)return}if(null!==i.lastChild){var o=i.lastChild,r=o.previousSibling;o&&v.tags.horizontalRule&&o.nodeName.toLocaleLowerCase()===v.tags.horizontalRule?i.removeChild(o):o&&r&&n.text(o).length<1&&r.nodeName.toLowerCase()===v.tags.horizontalRule&&o.nodeName.toLowerCase()===v.tags.paragraph&&(i.removeChild(o),i.removeChild(r))}}},g={element:null,modifier:"auto",placeholder:"",autofocus:!1,autoHR:!0,mode:l.richMode,maxLength:-1,modifiers:{b:"bold",i:"italicize",u:"underline",v:"paste"},tags:{"break":"br",horizontalRule:"hr",paragraph:"p",outerLevel:["pre","blockquote","figure"],innerLevel:["a","b","u","i","img","strong"]},cssClasses:{editor:"Medium",pasteHook:"Medium-paste-hook",placeholder:"Medium-placeholder",clear:"Medium-clear"},attributes:{remove:["style","class"]},pasteAsText:!0,beforeInvokeElement:function(){},beforeInsertHtml:function(){},maxLengthReached:function(e){},beforeAddTag:function(e,t,n,i){},keyContext:null,pasteEventHandler:function(t){t=t||e.event,c.makeUndoable();var o,r=c.value().length;if(v.pasteAsText){n.preventDefaultEvent(t);var a=n.selection.saveSelection(),s=prompt(l.Messages.pastHere)||"";if(s.length>0)return i.focus(),l.activeElement=i,n.selection.restoreSelection(a),s=n.encodeHtml(s),o=s.length+r,v.maxLength>0&&o>v.maxLength&&(s=s.substring(0,v.maxLength-r)),v.mode!==l.inlineMode&&(s=s.replace(/\n/g,"<br>")),new l.Html(c,s).setClean(!1).insert(v.beforeInsertHtml,!0),c.clean(),c.placeholders(),!1}else setTimeout(function(){c.clean(),c.placeholders()},20)},drag:!1},v=n.deepExtend(g,t),C={};for(s in g)g.hasOwnProperty(s)&&"object"!=typeof g[s]&&g.hasOwnProperty(s)&&v.element.getAttribute("data-medium-"+a)&&(o=v.element.getAttribute("data-medium-"+a),("false"===o.toLowerCase()||"true"===o.toLowerCase())&&(o="true"===o.toLowerCase()),v[s]=o);if(v.modifiers)for(s in v.modifiers)"undefined"!=typeof a[s]&&(v.modifiers[a[s]]=v.modifiers[s]);if(v.keyContext)for(s in v.keyContext)"undefined"!=typeof a[s]&&(v.keyContext[a[s]]=v.keyContext[s]);i=v.element,i.contentEditable=!0,i.className+=" "+v.cssClasses.editor+(" "+v.cssClasses.editor+"-"+v.mode),v.tags=v.tags||{},v.tags.outerLevel&&(v.tags.outerLevel=v.tags.outerLevel.concat([v.tags.paragraph,v.tags.horizontalRule])),this.settings=v,this.element=i,this.intercept=p,this.action=u,this.cache=h,this.cursor=f,this.utils=n,this.selection=m,C.element=i,C.medium=this,C.settings=v,C.action=u,C.cache=h,C.cursor=f,C.intercept=p,C.utils=n,C.selection=m,u.setBridge(C),h.setBridge(C),f.setBridge(C),m.setBridge(C),c.clean(),c.placeholders(),u.preserveElementFocus(),u.listen(),r?this.makeUndoable=function(){}:(this.dirty=!1,this.undoable=new l.Undoable(this),this.undo=this.undoable.undo,this.redo=this.undoable.redo,this.makeUndoable=this.undoable.makeUndoable),v.drag&&(d=c.drag=new l.Drag(c),n.addEvent(i,"mousemove",function(t){t=t||e.event;var n=t.target||{};"false"===n.getAttribute("contenteditable")&&d.show(n)})),i.medium=this,h.initialized=!0};return l.prototype={placeholders:function(){if(e.getComputedStyle){var i=this.settings,o=this.placeholder||(this.placeholder=t.createElement("div")),r=this.element,a=o.style,s=e.getComputedStyle(r,null),d=function(e){return s.getPropertyValue(e)},c=n.text(r),u=this.cursor,h=r.children.length,f=l.activeElement===r;if(r.placeholder=o,!f&&c.length<1&&2>h){if(r.placeHolderActive)return;r.innerHTML.match("<"+i.tags.paragraph)||(r.innerHTML=""),i.placeholder.length>0&&(o.setup||(o.setup=!0,a.background=d("background"),a.backgroundColor=d("background-color"),a.fontSize=d("font-size"),a.color=s.color,a.marginTop=d("margin-top"),a.marginBottom=d("margin-bottom"),a.marginLeft=d("margin-left"),a.marginRight=d("margin-right"),a.paddingTop=d("padding-top"),a.paddingBottom=d("padding-bottom"),a.paddingLeft=d("padding-left"),a.paddingRight=d("padding-right"),a.borderTopWidth=d("border-top-width"),a.borderTopColor=d("border-top-color"),a.borderTopStyle=d("border-top-style"),a.borderBottomWidth=d("border-bottom-width"),a.borderBottomColor=d("border-bottom-color"),a.borderBottomStyle=d("border-bottom-style"),a.borderLeftWidth=d("border-left-width"),a.borderLeftColor=d("border-left-color"),a.borderLeftStyle=d("border-left-style"),a.borderRightWidth=d("border-right-width"),a.borderRightColor=d("border-right-color"),a.borderRightStyle=d("border-right-style"),o.className=i.cssClasses.placeholder+" "+i.cssClasses.placeholder+"-"+i.mode,o.innerHTML="<div>"+i.placeholder+"</div>",r.parentNode.insertBefore(o,r)),r.className+=" "+i.cssClasses.clear,a.display="",a.minHeight=r.clientHeight+"px",a.minWidth=r.clientWidth+"px",i.mode!==l.inlineMode&&i.mode!==l.inlineRichMode&&(this.setupContents(),0===h&&r.firstChild&&u.set(this,0,r.firstChild))),r.placeHolderActive=!0}else r.placeHolderActive&&(r.placeHolderActive=!1,a.display="none",r.className=n.trim(r.className.replace(i.cssClasses.clear,"")),this.setupContents())}},clean:function(t){var i,o,r,a=this.settings,s=a.cssClasses.placeholder,d=(a.attributes||{}).remove||[],c=a.tags||{},u=c.outerLevel||null,h=c.innerLevel||null,f={},m={},p=(c.paragraph||"").toUpperCase();this.html;if(t=t||a.element,a.mode===l.inlineRichMode&&(u=a.tags.innerLevel),null!==u)for(r=0;r<u.length;r++)f[u[r].toUpperCase()]=!0;if(null!==h)for(r=0;r<h.length;r++)m[h[r].toUpperCase()]=!0;n.traverseAll(t,{element:function(t,a,l,c){var g=t.nodeName,v=!0;for(r=0;r<d.length;r++)i=d[r],t.hasAttribute(i)&&t.getAttribute(i)!==s&&t.removeAttribute(i);if((null!==u||null!==h)&&(1===l&&void 0!==f[g]?v=!1:l>1&&void 0!==m[g]&&(v=!1),v))if("block"===e.getComputedStyle(t,null).getPropertyValue("display")){if(p.length>0&&p!==g&&n.changeTag(t,p),l>1)for(;c.childNodes.length>a;)c.parentNode.insertBefore(c.lastChild,c.nextSibling)}else switch(g){case"BR":if(t===t.parentNode.lastChild){if(t===t.parentNode.firstChild)break;o=document.createTextNode(""),o.innerHTML="&nbsp",t.parentNode.insertBefore(o,t);break}default:for(;null!==t.firstChild;)t.parentNode.insertBefore(t.firstChild,t);n.detachNode(t)}}})},insertHtml:function(e,t,i){var o=new l.Html(this,e).insert(this.settings.beforeInsertHtml);return i===!0&&n.triggerEvent(this.element,"change"),t&&t.apply(o),this},addTag:function(e,n,i,o){if(!this.settings.beforeAddTag(e,n,i,o)){var r,a=t.createElement(e);return"undefined"!=typeof i&&i===!1&&(a.contentEditable=!1),0==a.innerHTML.length&&(a.innerHTML=" "),o&&o.nextSibling?(o.parentNode.insertBefore(a,o.nextSibling),r=o.nextSibling):(this.element.appendChild(a),r=this.lastChild()),n&&(this.cache.focusedElement=r,this.cursor.set(this,0,r)),a}return null},invokeElement:function(e,t,i){var o=this.settings,t=t||{},r=t.remove||[];switch(o.mode){case l.inlineMode:case l.partialMode:return this}return r.length>0&&(n.arrayContains(o,"class")||r.push("class")),new l.Element(this,e,t).invoke(this.settings.beforeInvokeElement),i===!0&&n.triggerEvent(this.element,"change"),this},behavior:function(){return r?l.wildBehavior:l.domesticatedBehavior},value:function(e){return"undefined"==typeof e?this.element.innerHTML:(this.element.innerHTML=e,this.clean(),this.placeholders(),this)},focus:function(){var e=this.element;return e.focus(),this},select:function(){var n,i,o=this.element;return o.focus(),t.body.createTextRange?(n=t.body.createTextRange(),n.moveToElementText(o),n.select()):e.getSelection&&(i=e.getSelection(),n=t.createRange(),n.selectNodeContents(o),i.removeAllRanges(),i.addRange(n)),this},isActive:function(){return l.activeElement===this.element},setupContents:function(){var e,n=this.element,i=n.children,o=n.childNodes,r=this.settings;return!r.tags.paragraph||i.length>0||r.mode===l.inlineMode||r.mode===l.inlineRichMode?l.Utilities:(o.length>0?(e=t.createElement(r.tags.paragraph),n.innerHTML.match("^[&]nbsp[;]")&&(n.innerHTML=n.innerHTML.substring(6,n.innerHTML.length-1)),e.innerHTML=n.innerHTML,n.innerHTML="",n.appendChild(e),this.cursor.set(this,e.innerHTML.length,e)):(e=t.createElement(r.tags.paragraph),e.innerHTML="&nbsp;",n.appendChild(e)),this)},destroy:function(){var e=this.element,t=this.intercept,i=this.settings,o=this.placeholder||null;null!==o&&o.setup&&(o.parentNode.removeChild(o),delete e.placeHolderActive),e.removeAttribute("contenteditable"),e.className=n.trim(e.className.replace(i.cssClasses.editor,"").replace(i.cssClasses.clear,"").replace(i.cssClasses.editor+"-"+i.mode,"")),n.removeEvent(e,"keyup",t.up).removeEvent(e,"keydown",t.down).removeEvent(e,"focus",t.focus).removeEvent(e,"blur",t.focus).removeEvent(e,"paste",i.pasteEventHandler)},clear:function(){this.element.innerHTML="",this.placeholders()},splitAtCaret:function(){if(!this.isActive())return null;var n,i=e.getSelection||t.selection,o=i(),r=o.focusOffset,a=o.focusNode,l=this.element,s=t.createRange(),d=t.createRange();return s.setStart(a,r),d.selectNodeContents(l),s.setEnd(d.endContainer,d.endOffset),n=s.extractContents()},deleteSelection:function(){if(this.isActive()){var e,t=i.getSelection();t.rangeCount>0&&(e=t.getRangeAt(0),e.deleteContents())}},lastChild:function(){return this.element.lastChild}},l.Element=function(e,t,n){if(this.medium=e,this.element=e.settings.element,r)this.tagName=t;else switch(t.toLowerCase()){case"bold":this.tagName="b";break;case"italic":this.tagName="i";break;case"underline":this.tagName="u";break;default:this.tagName=t}this.attributes=n||{},this.clean=!0},l.Html=function(e,t){this.medium=e,this.element=e.settings.element,this.clean=!0},l.Injector=function(){},r?(l.Element.prototype={invoke:function(e){l.activeElement===this.element&&(e&&e.apply(this),t.execCommand(this.tagName,!1))},setClean:function(){return this}},l.Injector.prototype={inject:function(e,t){return this.insertHTML(e,t),null}},l.Undoable=function(){}):(i.rangePrototype.insertNodeAtEnd=function(e){var t=this.cloneRange();t.collapse(!1),t.insertNode(e),t.detach(),this.setEndAfter(e)},l.Element.prototype={invoke:function(t){if(l.activeElement===this.element){t&&t.apply(this);var n,o,r=this.attributes,a=this.tagName.toLowerCase();void 0!==r.className?(o=(r.className.split[" "]||[r.className]).shift(),delete r.className):o="medium-"+a,n=i.createClassApplier(o,{elementTagName:a,elementAttributes:this.attributes}),this.medium.makeUndoable(),n.toggleSelection(e),this.clean&&(this.medium.clean(),this.medium.placeholders())}},setClean:function(e){return this.clean=e,this}},l.Injector.prototype={inject:function(e){var n,i=!1;if("string"==typeof e){var o=t.createElement("div");o.innerHTML=e,n=o.childNodes,i=!0}else n=e;this.insertHTML('<span id="wedge"></span>');var r=t.getElementById("wedge"),a=r.parentNode,l=0;if(r.removeAttribute("id"),i)for(;l<n.length;)a.insertBefore(n[l],r);else a.insertBefore(n,r);return a.removeChild(r),r=null,n}},l.Undoable=function(e){var t,i=this,o=e.settings.element,r=o.innerHTML,l=new Undo.Stack,s=Undo.Command.extend({constructor:function(e,t){this.oldValue=e,this.newValue=t},execute:function(){},undo:function(){o.innerHTML=this.oldValue,e.canUndo=l.canUndo(),e.canRedo=l.canRedo(),e.dirty=l.dirty()},redo:function(){o.innerHTML=this.newValue,e.canUndo=l.canUndo(),e.canRedo=l.canRedo(),e.dirty=l.dirty()}}),d=function(){var t=o.innerHTML;t!=r&&(i.movingThroughStack||(l.execute(new s(r,t)),r=t,e.dirty=l.dirty()),n.triggerEvent(e.settings.element,"change"))};this.medium=e,this.timer=t,this.stack=l,this.makeUndoable=d,this.EditCommand=s,this.movingThroughStack=!1,n.addEvent(o,"keyup",function(e){return e.ctrlKey||e.keyCode===a.z?void n.preventDefaultEvent(e):(clearTimeout(t),void(t=setTimeout(function(){d()},250)))}).addEvent(o,"keydown",function(e){return e.ctrlKey&&e.keyCode===a.z?(n.preventDefaultEvent(e),i.movingThroughStack=!0,void(e.shiftKey?l.canRedo()&&l.redo():l.canUndo()&&l.undo())):(i.movingThroughStack=!1,!0)})}),l.Injector.prototype.insertHTML=function(n,i){var o,r;if(e.getSelection){if(o=e.getSelection(),o.getRangeAt&&o.rangeCount){r=o.getRangeAt(0),r.deleteContents();var a=t.createElement("div");a.innerHTML=n;for(var l,s,d=t.createDocumentFragment();l=a.firstChild;)s=d.appendChild(l);var c=d.firstChild;r.insertNode(d),s&&(r=r.cloneRange(),r.setStartAfter(s),i?r.setStartBefore(c):r.collapse(!0),o.removeAllRanges(),o.addRange(r))}}else if((o=t.selection)&&"Control"!=o.type){var u=o.createRange();u.collapse(!0),o.createRange().pasteHTML(n),i&&(r=o.createRange(),r.setEndPoint("StartToStart",u),r.select())}},l.Html.prototype={insert:function(e,t){if(l.activeElement===this.element){e&&e.apply(this);var n=this.injector.inject(this.html,t);return this.clean&&(this.medium.clean(),this.medium.placeholders()),this.medium.makeUndoable(),n}return null},injector:new l.Injector,setClean:function(e){return this.clean=e,this}},l.Utilities=n={isCommand:function(e,t,n,i){return"ctrl"===e.modifier&&t.ctrlKey||"cmd"===e.modifier&&t.metaKey||"auto"===e.modifier&&(t.ctrlKey||t.metaKey)?n.call():i.call()},isShift:function(e,t,n){return e.shiftKey?t.call():n.call()},isModifier:function(e,t,n){var i=e.modifiers[t.keyCode];return i?n.call(null,i):!1},special:function(){var e={};return e[a.backspace]=!0,e[a.shift]=!0,e[a.ctrl]=!0,e[a.alt]=!0,e[a["delete"]]=!0,e[a.cmd]=!0,e}(),isSpecial:function(e,t){return e?!0:"undefined"!=typeof l.Utilities.special[t.keyCode]},navigational:function(){var e={};return e[a.upArrow]=!0,e[a.downArrow]=!0,e[a.leftArrow]=!0,e[a.rightArrow]=!0,e}(),isNavigational:function(e){return"undefined"!=typeof l.Utilities.navigational[e.keyCode]},addEvents:function(e,t,n){for(var i,o=0,r=t.split(" "),a=r.length,s=l.Utilities;a>o;o++)i=r[o],i.length>0&&s.addEvent(e,i,n);return l.Utilities},addEvent:function(e,t,n){return e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n,l.Utilities},removeEvent:function(e,t,n){return e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent?e.detachEvent("on"+t,n):e["on"+t]=null,l.Utilities},preventDefaultEvent:function(e){return e.preventDefault?e.preventDefault():e.returnValue=!1,l.Utilities},stopPropagation:function(e){return e=e||window.event,e.cancelBubble=!0,void 0!==e.stopPropagation&&e.stopPropagation(),l.Utilities},isEventSupported:function(e,n){n="on"+n;var i=t.createElement(e.tagName),o=n in i;return o||(i.setAttribute(n,"return;"),o="function"==typeof i[n]),i=null,o},triggerEvent:function(e,n){var i;return t.createEvent?(i=t.createEvent("HTMLEvents"),i.initEvent(n,!0,!0),i.eventName=n,e.dispatchEvent(i)):(i=t.createEventObject(),e.fireEvent("on"+n,i)),l.Utilities},deepExtend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(t[n]&&t[n].constructor&&t[n].constructor===Object?(e[n]=e[n]||{},l.Utilities.deepExtend(e[n],t[n])):e[n]=t[n]);return e},pasteHook:function(e,i){var o,a,s,d=t.createElement("textarea"),c=e.element,u=e.settings;e.html;return d.className=u.cssClasses.pasteHook,c.parentNode.appendChild(d),d.focus(),r||e.makeUndoable(),setTimeout(function(){c.focus(),u.maxLength>0&&(o=n.text(c),a=o.length,s=a+d.value.length,s>a&&(d.value=d.value.substring(0,u.maxLength-a))),i(d.value),n.detachNode(d)},2),l.Utilities},traverseAll:function(e,t,n){var i,o=e.childNodes,r=o.length,a=0,n=n||1;if(t=t||{},r>0)for(;r>a;a++){switch(i=o[a],i.nodeType){case 1:l.Utilities.traverseAll(i,t,n+1),void 0!==t.element&&t.element(i,a,n,e);break;case 3:void 0!==t.fragment&&t.fragment(i,a,n,e)}r=o.length,i===e.lastChild&&(a=r)}return l.Utilities},trim:function(e){return e.replace(/^[\s]+|\s+$/g,"")},arrayContains:function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1},addClass:function(e,t){return e.classList?e.classList.add(t):e.className+=" "+t,l.Utilities},removeClass:function(e,t){return e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t.split(" ").join("|")+"(\\b|$)","gi")," "),l.Utilities},hasClass:function(e,t){return e.classList?e.classList.contains(t):new RegExp("(^| )"+t+"( |$)","gi").test(e.className)},isHidden:function(e){return 0===e.offsetWidth||0===e.offsetHeight},isVisible:function(e){return 0!==e.offsetWidth||0!==e.offsetHeight},encodeHtml:function(e){return t.createElement("a").appendChild(t.createTextNode(e)).parentNode.innerHTML},text:function(e,t){if(t)e.textContent&&"undefined"!=typeof e.textContent?e.textContent=t:e.innerText=t;else{if(e.innerText)return n.trim(e.innerText);if(e.textContent)return n.trim(e.textContent);if(e.data)return n.trim(e.data)}return""},changeTag:function(e,n){var i,o,r=t.createElement(n);for(i=e.firstChild;i;)o=i.nextSibling,r.appendChild(i),i=o;return e.parentNode.insertBefore(r,e),e.parentNode.removeChild(e),r},detachNode:function(e){return null!==e.parentNode&&e.parentNode.removeChild(e),e},baseAtCaret:function(t){if(!t.isActive())return null;var n=e.getSelection?e.getSelection():document.selection;if(n.rangeCount){var i=n.getRangeAt(0),o=i.endContainer;switch(o.nodeType){case 3:if(o.data&&o.data.length!=i.endOffset)return!1}return o}return null},atCaret:function(e){var t=this.baseAtCaret(e)||{},n=e.element;if(t===!1)return null;for(;t&&t.parentNode!==n;)t=t.parentNode;return t&&1==t.nodeType?t:null},hide:function(e){e.style.display="none"},show:function(e){e.style.display=""},hideAnim:function(e){e.style.opacity=1},showAnim:function(e){e.style.opacity=.01,e.style.display=""}},l.Selection=function(){},l.Selection.prototype={setBridge:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},saveSelection:function(){if(e.getSelection){var n=e.getSelection();if(n.rangeCount>0)return n.getRangeAt(0)}else if(t.selection&&t.selection.createRange)return t.selection.createRange();return null},restoreSelection:function(n){if(n)if(e.getSelection){var i=e.getSelection();i.removeAllRanges(),i.addRange(n)}else t.selection&&n.select&&n.select()}},l.Cursor=function(){},l.Cursor.prototype={setBridge:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},set:function(i,o,r){var a;this.html;if(t.createRange){var l=e.getSelection(),s=i.lastChild(),d=n.text(s).length-1,c=r?r:s,u="undefined"!=typeof o&&null!==o?o:d;a=t.createRange(),a.setStart(c,u),a.collapse(!0),l.removeAllRanges(),l.addRange(a)}else a=t.body.createTextRange(),a.moveToElementText(r),a.collapse(!1),a.select()},parent:function(){var n,i=null;return e.getSelection?(n=e.getSelection().getRangeAt(0),i=n.commonAncestorContainer,i=1===i.nodeType?i:i.parentNode):t.selection&&(i=t.selection.createRange().parentElement()),"SPAN"==i.tagName&&(i=i.parentNode),i},caretToBeginning:function(e){this.set(this,0,e)},caretToEnd:function(e){this.set(this,n.text(e).length,e)}},l.Toolbar=function(i,o){var r=t.createElement("div"),a=this;r.innerHTML=this.html,this.buttons=o,this.element=r.children[0],t.body.appendChild(this.element),this.active=!1,this.busy=!0,n.addEvents(document,"mouseup keyup",function(e){l.activeElement!==i.element||a.busy||a.goToSelection()}).addEvent(e,"scroll",function(){a.active&&a.goToSelection()})},l.Toolbar.prototype={fixedClass:"Medium-toolbar-fixed",showClass:"Medium-toolbar-show",hideClass:"Medium-toolbar-hide",html:'<div class="Medium-toolbar">	<div class="Medium-tail-outer">		<div class="Medium-tail-inner"></div>	</div>	<div id="Medium-buttons"></div>	<table id="Medium-options">		<tbody>			<tr>			</tr>		</tbody>	</table></div>',goToSelection:function(){var t=this.getHighlighted(),i=t.boundary.top-5,o=this.element,r=o.style;e.scrollTop>0?n.addClass(o,this.fixedClass):n.removeClass(o,this.fixedClass),null!==t&&(t.range.startOffset!==t.range.endOffset||t.text?(n.removeClass(o,this.hideClass).removeClass(o,this.showClass),r.opacity=.01,n.addClass(o,this.showClass),r.opacity=1,r.top=i-65+"px",r.left=t.boundary.left+t.boundary.width/2-o.clientWidth/2+"px",this.active=!0):(n.removeClass(o,this.showClass).addClass(o,this.hideClass),this.active=!1))},getHighlighted:function(){var t=e.getSelection(),i=t.anchorNode?t.getRangeAt(0):!1;return i?{selection:t,range:i,text:n.trim(i.toString()),boundary:i.getBoundingClientRect()}:null}},l.Drag=function(i){this.medium=i;var o=this,r=this.iconSrc.replace(/[{][{]([a-zA-Z]+)[}][}]/g,function(e,t){return o.hasOwnProperty(t)?o[t]:e}),a=this.icon=t.createElement("img");a.className=this.buttonClass,a.setAttribute("contenteditable","false"),a.setAttribute("src",r),this.hide(),this.element=null,this.protectedElement=null,n.addEvent(a,"dragstart",function(t){null===o.protectedElement&&(t=t||e.event,o.protectedElement=n.detachNode(o.element),o.icon.style.opacity=0)}).addEvent(a,"mouseover",function(e){null===o.protectedElement&&n.stopPropagation(e).addClass(o.element,o.elementClass)}).addEvent(a,"mouseout",function(e){null===o.protectedElement&&n.stopPropagation(e).removeClass(o.element,o.elementClass)}).addEvent(a,"dragend",t.body.ondragend=function(e){null!==o.protectedElement&&setTimeout(function(){o.cleanCanvas(),o.protectedElement=null},1)})},l.Drag.prototype={elementClass:"Medium-focused",buttonClass:"Medium-drag",iconSrc:'data:image/svg+xml;utf8,<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="21.424px" height="21.424px" viewBox="0 0 21.424 21.424" style="enable-background:new 0 0 21.424 21.424;" xml:space="preserve">	<g>		<g>			<path style="fill:{{iconColor}};" d="M13.616,17.709L13.616,17.709h0.781l-3.686,3.715l-3.685-3.715h0.781l0,0H13.616z M13.616,17.709 M14.007,17.709 M12.555,19.566 M8.87,19.566 M7.418,17.709 M7.809,17.709 M10.712,17.709"/>			<path style="fill:{{iconColor}};" d="M13.616,3.715L13.616,3.715h0.781L10.712,0L7.027,3.715h0.781l0,0H13.616z M13.616,3.715 M14.007,3.715 M12.555,1.858 M8.87,1.858 M7.418,3.715 M7.809,3.715 M10.712,3.715"/>			<path style="fill:{{iconColor}};" d="M3.716,13.616L3.716,13.616v0.781L0,10.712l3.716-3.685v0.781l0,0V13.616z M3.716,13.616 M3.716,14.007 M1.858,12.555 M1.858,8.87 M3.716,7.417 M3.716,7.808 M3.716,10.712"/>			<path style="fill:{{iconColor}};" d="M17.709,13.616L17.709,13.616v0.781l3.715-3.685l-3.715-3.685v0.781l0,0V13.616z M17.709,13.616 M17.709,14.007 M19.566,12.555 M19.566,8.87 M17.709,7.417 M17.709,7.808 M17.709,10.712"/>		</g>		<path style="fill-rule:evenodd;clip-rule:evenodd;fill:{{iconColor}};" d="M10.712,6.608c2.267,0,4.104,1.838,4.104,4.104 c0,2.266-1.837,4.104-4.104,4.104c-2.266,0-4.104-1.837-4.104-4.104C6.608,8.446,8.446,6.608,10.712,6.608L10.712,6.608z M10.712,7.515c-1.765,0-3.196,1.432-3.196,3.197s1.432,3.197,3.196,3.197c1.766,0,3.197-1.432,3.197-3.197 S12.478,7.515,10.712,7.515z"/>	</g></svg>',iconColor:"#231F20",hide:function(){n.hide(this.icon)},show:function(e){if(e!==this.icon||null!==this.protectedElement){this.element=e;var t=this.icon.style,i=e.offsetLeft,o=e.offsetTop;e.dragIcon=this.icon,e.parentNode.appendChild(this.icon),t.opacity=1,t.left=i+"px",t.top=o+"px",n.show(this.icon)}},cleanCanvas:function(){var e,i=!1,o=t.getElementsByClassName(this.buttonClass);for(this.icon.style.opacity=1;o.length>0;)n.isVisible(e=o[0])&&(i||(e.parentNode.insertBefore(this.element,e),i=!0),n.detachNode(e));n.detachNode(this.icon)}},l.Action=function(){},l.Action.prototype={setBridge:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},listen:function(){var e=this.element,t=this.intercept;n.addEvent(e,"keyup",t.up).addEvent(e,"keydown",t.down).addEvent(e,"focus",t.focus).addEvent(e,"blur",t.blur).addEvent(e,"paste",this.settings.pasteEventHandler)},preserveElementFocus:function(){var n=e.getSelection?e.getSelection().anchorNode:t.activeElement;if(n){var i,o=this.medium.cache,r=this.settings,a=n.parentNode,l=r.element.children,s=a!==o.focusedElement,d=0;for(a===r.element&&(a=n),i=0;i<l.length;i++)if(a===l[i]){d=i;break}s&&(o.focusedElement=a,o.focusedElementIndex=d)}}},l.Cache=function(){this.initialized=!1,this.cmd=!1,this.focusedElement=null},l.Cache.prototype={setBridge:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}},l.inlineMode="inline",l.partialMode="partial",l.richMode="rich",l.inlineRichMode="inlineRich",l.Messages={pastHere:"Paste Here"},l.domesticatedBehavior="domesticated",l.wildBehavior="wild",l}();"function"==typeof define&&define.amd?define(function(){return n}):"undefined"!=typeof module&&module.exports?module.exports=n:"undefined"!=typeof this&&(this.Medium=n)}).call(this,window,document);